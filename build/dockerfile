FROM alpine:3.17.2

WORKDIR /usr/local/apps/gibber

# Bring alpine as up to date as possible
RUN apk update && apk upgrade
    
# Install the dependencies required to build python from source
RUN apk add --no-cache git bash curl gcc g++ make build-base libffi-dev openssl-dev bzip2-dev zlib-dev xz-dev readline-dev sqlite-dev tk-dev

# install and configure pyenv 
RUN curl https://pyenv.run | bash && \
    echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc && \
    echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc && \
    echo 'eval "$(pyenv init -)"' >> ~/.bashrc && \
    echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bashrc && \
    echo 'source ~/.bashrc' >> ~/.bash_profile 

# install python
# TODO: Remove hardcoded python version and install version specified for application 
RUN source ~/.bashrc && pyenv install 3.9.16

# Bring in the build script
COPY ./build.sh . 

# Make the build script executable
RUN chmod +x ./build.sh

ENTRYPOINT [ "/usr/bin/env", "bash", "-c", "./build.sh" ]